<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Történelmi Kalandjáték</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        h1, h2 {
            color: #5a4a42;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .task {
            display: none; /* Hide all tasks by default */
            margin-top: 20px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        input, select {
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 200px;
        }

        .message {
            margin-top: 15px;
            font-weight: bold;
            color: #d9534f;
        }

        .success-message {
            color: #5cb85c;
        }

        /* Task 1 & 5: Jigsaw Puzzle */
        #jigsaw-container, #jigsaw-container-2 {
            position: relative;
            border: 2px solid #ccc;
            margin: 20px auto;
            width: 400px; /* Fixed width */
            height: 300px; /* Fixed height */
            background-color: #eee;
            /* Added for grid layout */
            display: flex;
            flex-wrap: wrap;
            padding: 0;
        }
        #jigsaw-pieces, #jigsaw-pieces-2 {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
            border: 2px dashed #ccc;
            padding: 10px;
        }
        .jigsaw-piece {
            background-size: cover;
            cursor: grab;
            border: 1px solid #fff;
        }
        .jigsaw-slot {
            border: 1px dashed #aaa;
            background-color: #f9f9f9;
        }

        /* Task 3: Timeline */
        #timeline-container {
            list-style-type: none;
            padding: 0;
            width: 300px;
            margin: 20px auto;
        }
        .timeline-item {
            background-color: #e7e7e7;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 5px;
            cursor: move;
            user-select: none;
        }
        .timeline-item.dragging {
            opacity: 0.5;
        }

        /* Task 4: Morse Code */
        #morse-abc {
            font-family: 'Courier New', Courier, monospace;
            text-align: left;
            max-width: 300px;
            margin: 20px auto;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }

        /* Task 6: Lightning Quiz */
        #quiz-timer-bar-container {
            width: 100%;
            background-color: #ddd;
            height: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        #quiz-timer-bar {
            width: 100%;
            height: 100%;
            background-color: #4CAF50;
            border-radius: 10px;
            transition: width 0.1s linear;
        }
        .quiz-option {
            display: block;
            width: 80%;
            margin: 5px auto;
        }

        /* Task 7: Spot the Difference */
        #spot-the-difference-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .spot-image-wrapper {
            position: relative;
        }
        .spot-image-wrapper img {
            display: block;
            max-width: 400px;
            height: auto;
        }
        .difference-circle {
            position: absolute;
            border: 3px solid red;
            border-radius: 50%;
            pointer-events: none; /* So it doesn't interfere with clicks */
            box-sizing: border-box;
        }

    </style>
</head>
<body>

<div class="container">
    <!-- ================================================== -->
    <!-- START SCREEN -->
    <!-- ================================================== -->
    <div id="start-screen">
        <h1 data-text="start_title">Történelmi Kalandjáték</h1>
        <p data-text="start_intro">Válasszátok ki a csapatotok színét és a feladat sorszámát a kezdéshez!</p>
        <div>
            <label for="team-color" data-text="start_team_label">Csapat színe:</label>
            <select id="team-color">
                <option value="yellow">Sárga</option>
                <option value="green">Zöld</option>
                <option value="red">Piros</option>
                <option value="blue">Kék</option>
            </select>
        </div>
        <div>
            <label for="task-number" data-text="start_task_label">Feladat sorszáma:</label>
            <input type="number" id="task-number" min="1" max="7" value="1">
        </div>
        <button onclick="startGame()" data-text="start_button">Kezdés!</button>
    </div>

    <!-- ================================================== -->
    <!-- TASK 1: JIGSAW PUZZLE -->
    <!-- ================================================== -->
    <div id="task-1" class="task">
        <h2 data-text="task1_title">1. Feladat: Képkirakó</h2>
        <p data-text="task1_instruction">Rakjátok össze a darabokból a képet!</p>
        <div id="jigsaw-container"></div>
        <div id="jigsaw-pieces"></div>
        <div id="task-1-message" class="message success-message" style="display:none;">
            <!-- Success message is set from JS -->
        </div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 2: SELFIE CHALLENGE -->
    <!-- ================================================== -->
    <div id="task-2" class="task">
        <h2 data-text="task2_title">2. Feladat: Alkosd újra!</h2>
        <p id="task-2-instruction" data-text="task2_instruction">Képzeljétek el, hogy most itt vagytok, alkossátok meg a képet és készítsetek egy szelfit.</p>
        <img id="task-2-image" src="" alt="Alkossátok újra" style="max-width: 400px; margin: 10px auto; display: block;">
        <button id="task-2-button" onclick="showTask2Result()" data-text="task2_button">Nyomd meg, ha kész vagy</button>
        <div id="task-2-message" class="message success-message" style="display:none;"></div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 3: TIMELINE SORT -->
    <!-- ================================================== -->
    <div id="task-3" class="task">
        <h2 data-text="task3_title">3. Feladat: Idővonal</h2>
        <p data-text="task3_instruction">Húzzátok a neveket a helyes időrendi sorrendbe!</p>
        <ul id="timeline-container"></ul>
        <button onclick="checkTimelineOrder()" data-text="task3_button">Sorrend ellenőrzése</button>
        <div id="task-3-message" class="message"></div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 4: MORSE CODE -->
    <!-- ================================================== -->
    <div id="task-4" class="task">
        <h2 data-text="task4_title">4. Feladat: Morse-kód</h2>
        <p data-text="task4_instruction">Fejtsétek meg a titkos üzenetet a morzeábécé segítségével!</p>
        <div id="morse-abc"></div>
        <p><strong data-text="task4_secret_label">Titkos üzenet:</strong></p>
        <p id="morse-secret-text" style="font-family: 'Courier New', Courier, monospace; font-size: 1.2em;"></p>
        <input type="text" id="morse-input" placeholder="Írjátok ide a megfejtést">
        <button onclick="checkMorseCode()" data-text="task4_button">Megfejtés ellenőrzése</button>
        <div id="task-4-message" class="message"></div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 5: JIGSAW PUZZLE 2 -->
    <!-- ================================================== -->
    <div id="task-5" class="task">
        <h2 data-text="task5_title">5. Feladat: Képkirakó 2</h2>
        <p data-text="task5_instruction">Rakjátok össze a darabokból a képet!</p>
        <div id="jigsaw-container-2"></div>
        <div id="jigsaw-pieces-2"></div>
        <div id="task-5-message" class="message success-message" style="display:none;">
            <!-- Add success message here -->
        </div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 6: LIGHTNING QUIZ -->
    <!-- ================================================== -->
    <div id="task-6" class="task">
        <h2 data-text="task6_title">6. Feladat: Villámkvíz</h2>
        <div id="quiz-intro">
            <p data-text="task6_instruction">Válaszoljatok helyesen mind az 5 kérdésre. Minden kérdésre 5 másodpercetek van!</p>
            <button onclick="startQuiz()" data-text="task6_start_button">Kvíz indítása</button>
        </div>
        <div id="quiz-area" style="display:none;">
            <div id="quiz-timer-bar-container">
                <div id="quiz-timer-bar"></div>
            </div>
            <h3 id="quiz-question"></h3>
            <div id="quiz-options"></div>
        </div>
        <div id="quiz-result" style="display:none;">
            <p id="quiz-result-message"></p>
            <button id="quiz-restart-button" style="display:none;" onclick="restartQuiz()" data-text="task6_retry_button">Újrapróbálkozás</button>
        </div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 7: SPOT THE DIFFERENCE -->
    <!-- ================================================== -->
    <div id="task-7" class="task">
        <h2 data-text="task7_title">7. Feladat: Különbségkereső</h2>
        <p data-text="task7_instruction">Találjátok meg az 5 különbséget a két kép között! Kattintsatok a jobb oldali képen a különbségekre.</p>
        <p><span data-text="task7_found_label">Megtalált különbségek:</span> <span id="differences-found">0</span> / <span id="differences-total">5</span></p>
        <div id="spot-the-difference-container">
            <div class="spot-image-wrapper">
                <img id="spot-image-1" src="" alt="Eredeti kép">
            </div>
            <div class="spot-image-wrapper" id="spot-image-wrapper-2">
                <img id="spot-image-2" src="" alt="Módosított kép">
            </div>
        </div>
        <div id="task-7-message" class="message success-message" style="display:none;">
            <!-- Final success message -->
        </div>
    </div>

</div>

<script>

// =================================================================================
// GAME DATA - EDIT THIS SECTION FOR EACH TEAM
// =================================================================================
const gameData = {
    // General text used across the game, not specific to a task
    general: {
        start_title: "Történelmi Kalandjáték",
        start_intro: "Válasszátok ki a csapatotok színét és a feladat sorszámát a kezdéshez!",
        start_team_label: "Csapat színe:",
        start_task_label: "Feladat sorszáma:",
        start_button: "Kezdés!",
        task1_title: "1. Feladat: Képkirakó",
        task1_instruction: "Rakjátok össze a darabokból a képet!",
        task2_title: "2. Feladat: Alkosd újra!",
        task2_instruction: "Képzeljétek el, hogy most itt vagytok, alkossátok meg a képet és készítsetek egy szelfit.",
        task2_button: "Nyomd meg, ha kész vagy",
        task3_title: "3. Feladat: Idővonal",
        task3_instruction: "Húzzátok a neveket a helyes időrendi sorrendbe!",
        task3_button: "Sorrend ellenőrzése",
        task3_incorrect_order: "Nem jó a sorrend, próbáljátok újra!",
        task4_title: "4. Feladat: Morse-kód",
        task4_instruction: "Fejtsétek meg a titkos üzenetet a morzeábécé segítségével!",
        task4_secret_label: "Titkos üzenet:",
        task4_placeholder: "Írjátok ide a megfejtést",
        task4_button: "Megfejtés ellenőrzése",
        task4_incorrect_answer: "Helytelen megfejtés, próbáljátok újra!",
        task5_title: "5. Feladat: Képkirakó 2",
        task5_instruction: "Rakjátok össze a darabokból a képet!",
        task6_title: "6. Feladat: Villámkvíz",
        task6_instruction: "Válaszoljatok helyesen mind az 5 kérdésre. Minden kérdésre 5 másodpercetek van!",
        task6_start_button: "Kvíz indítása",
        task6_retry_button: "Újrapróbálkozás",
        task6_fail_message: "Sajnos nem minden válasz volt helyes. Próbáljátok újra!",
        task7_title: "7. Feladat: Különbségkereső",
        task7_instruction: "Találjátok meg az 5 különbséget a két kép között! Kattintsatok a jobb oldali képen a különbségekre.",
        task7_found_label: "Megtalált különbségek:",
    },
    yellow: {
        tasks: {
            1: { /* Jigsaw 1 */
                image: 'https://via.placeholder.com/400x300/FFEB3B/000000?text=Jigsaw+1',
                gridSize: 4, // 4x4 grid
                successMessage: 'Keresd meg a következő pontot és fejtsd meg, hogy kit ábrázol a kép! Hint: játszótér'
            },
            2: { /* Selfie */
                image: 'https://via.placeholder.com/400x300/FFEB3B/000000?text=Sárga+Csapat+Póz',
                successMessage: 'A képen I. István azaz Szent István volt, Hint: fa.'
            },
            3: { /* Timeline */
                items: ['Árpád fejedelem', 'Géza', 'Szent István', 'I. András', 'I Béla', 'Szent László', 'III István', 'II András', 'IV. Béla', 'Mátyás király'],
                correctOrder: ['Árpád fejedelem', 'Géza', 'Szent István', 'I. András', 'I Béla', 'Szent László', 'III István', 'II András', 'IV. Béla', 'Mátyás király'],
                successMessage: 'Szent István volt a keresztény magyar állam megalapitója. Hint: ajtó'
            },
            4: { /* Morse */
                secretMorse: '... --.. . -. -  .-.. .- ... --.. .-.. ---',
                correctAnswer: 'Szent László',
                successMessage: 'Szent István eredeti neve Vajk volt! A következő pont mosdók'
            },
            5: { /* Jigsaw 2 */
                image: 'https://via.placeholder.com/400x300/FFE0B2/000000?text=Jigsaw+2',
                gridSize: 5, // 5x5 grid
                successMessage: 'Szent István apja Géza fejedelem volt.! A következő feladat itt található: termünk.'
            },
            6: { /* Quiz */
                questions: [
                    { q: '1. Kiről van szó?', o: ['Szent István', 'Géza', 'Szent László'], a: 'Szent István' },
                    { q: '2. István apja', o: ['István', 'Géza', 'Álmos'], a: 'Géza' },
                    { q: 'István eredeti neve', o: ['István', 'Varj', 'Vajk'], a: 'Vajk' },
                    { q: 'Igen?', o: ['Nem', 'Igen', 'Nemtudom'], a: 'Igen' },
                    { q: 'Hányadik István Szent István?', o: ['I.', 'XIX.', 'III'], a: 'I.' },
                ],
                
                successMessage: 'Helyes!Szent István testvére Koppány volt. Hint: autó'
            },
            7: { /* Spot Difference */
                image1: 'https://raw.githubusercontent.com/Eroan21/myrepo/main/szentistvan.jpg',
                image2: 'https://raw.githubusercontent.com/Eroan21/myrepo/main/szentistvan_processed.jpg',
                // Coordinates: {x, y, r} as percentage of image width/height
                differences: [
                    { x: 45, y: 20, r: 10 }, { x: 13, y: 5, r: 8 },
                    { x: 92, y: 33, r: 9 }, { x: 75, y: 85, r: 7 },
                    { x: 22, y: 94, r: 8 }
                ],
                successMessage: 'Gratulálunk, minden különbséget megtaláltatok! A cél...'
            }
        }
    },
    // Simplified other teams to keep file valid
    green: {
        tasks: {
            1: { image: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=Green+Jigsaw', gridSize: 4, successMessage: 'Gratulálok! Kövi: mosdók' },
            2: { image: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=Green+Pose', successMessage: 'Green selfie done' },
            3: { items: ['Árpád fejedelem', 'Géza', 'Szent István'], correctOrder: ['Árpád fejedelem', 'Géza', 'Szent István'], successMessage: 'Ok' },
            4: { secretMorse: '.- .- .-', correctAnswer: 'AAA', successMessage: 'Ok' },
            5: { image: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=Green+Jigsaw+2', gridSize: 5, successMessage: 'Ok' },
            6: { questions: [ { q: 'Q?', o: ['A','B'], a: 'A' } ], successMessage: 'Ok' },
            7: { image1: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=G1', image2: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=G2', differences: [ { x: 20, y: 20, r: 8 } ], successMessage: 'Done' }
        }
    },
    red: {
        tasks: {
            1: { image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/de/Coloman_%28Chronica_Hungarorum%29.jpg/500px-Coloman_%28Chronica_Hungarorum%29.jpg', gridSize: 4, successMessage: 'Szuper!' },
            2: { image: 'https://via.placeholder.com/400x300/f44336/FFFFFF?text=Piros+Csapat+Póz', successMessage: 'Nagyszerű!' },
            3: { items: ['Árpád fejedelem', 'Géza', 'Szent István'], correctOrder: ['Árpád fejedelem', 'Géza', 'Szent István'], successMessage: 'Helyes!' },
            4: { secretMorse: '-- .- --.', correctAnswer: 'MAG', successMessage: 'Megfejtve!' },
            5: { image: 'https://via.placeholder.com/400x300/FFCDD2/000000?text=Red+Jigsaw+2', gridSize: 5, successMessage: 'Szipiszuper!' },
            6: { questions: [ { q: 'Mi?', o: ['A','B'], a: 'A' } ], successMessage: 'Kész!' },
            7: { image1: 'https://raw.githubusercontent.com/Eroan21/myrepo/main/kalman.jpg', image2: 'https://raw.githubusercontent.com/Eroan21/myrepo/main/kalman_processed.jpg',
                 differences: [ { x: 20, y: 10, r: 10 }, { x: 62, y: 30, r: 5 }, { x: 65, y: 10, r: 5 }, { x: 65, y: 55, r: 5 }, { x: 62, y: 42, r: 5 } ],
                 successMessage: 'Piros csapat - Célba értetek!' }
        }
    },
    blue: {
        tasks: {
            1: { image: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=Kék+Csapat+Kép+1', gridSize: 4, successMessage: 'Kék csapat - Szuper!' },
            2: { image: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=Kék+Csapat+Póz', successMessage: 'Kék csapat - Nagyszerű!' },
            3: { items: ['Árpád fejedelem', 'Géza', 'Szent István'], correctOrder: ['Árpád fejedelem', 'Géza', 'Szent István'], successMessage: 'Ok' },
            4: { secretMorse: '-.- . -.-', correctAnswer: 'KEK', successMessage: 'Kék csapat - Megfejtve!' },
            5: { image: 'https://via.placeholder.com/400x300/BBDEFB/000000?text=Blue+Jigsaw+2', gridSize: 5, successMessage: 'Kék csapat - Ügyesek!' },
            6: { questions: [ { q: 'Kék csapat - 1. kérdés?', o: ['Helyes', 'Rossz'], a: 'Helyes' } ], successMessage: 'Kék csapat - Kész!' },
            7: { image1: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=Kék+Kép+A', image2: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=Kék+Kép+B', differences: [ { x: 15, y: 15, r: 7 } ], successMessage: 'Kék csapat - Kész!' }
        }
    }
};

// =================================================================================
// GLOBAL VARIABLES & HELPER FUNCTIONS
// =================================================================================
let currentTeam = 'yellow';
let currentTask = 1;

function applyTextContent() {
    document.querySelectorAll('[data-text]').forEach(el => {
        const key = el.dataset.text;
        if (gameData.general[key]) el.innerText = gameData.general[key];
    });
}

function hideAllTasks() {
    document.querySelectorAll('.task').forEach(task => task.style.display = 'none');
}

function startGame() {
    currentTeam = document.getElementById('team-color').value;
    currentTask = parseInt(document.getElementById('task-number').value);

    if (isNaN(currentTask) || currentTask < 1 || currentTask > 7) {
        alert('Kérlek, adj meg egy érvényes feladat sorszámot (1-7).');
        return;
    }

    applyTextContent();
    document.getElementById('start-screen').style.display = 'none';
    loadTask(currentTask);
}

function loadTask(taskNumber) {
    hideAllTasks();
    const taskElement = document.getElementById(`task-${taskNumber}`);
    if (taskElement) {
        taskElement.style.display = 'block';
        // Call the setup function for the specific task
        const setupFunction = window[`setupTask${taskNumber}`];
        if (typeof setupFunction === 'function') {
            setupFunction();
        }
    } else {
        alert('Nincs ilyen feladat!');
    }
}

// =================================================================================
// TASK 1 & 5: JIGSAW PUZZLE LOGIC
// =================================================================================
function setupJigsaw(taskNum, containerId, piecesId, messageId) {
    const taskData = gameData[currentTeam].tasks[taskNum];
    const container = document.getElementById(containerId);
    const piecesContainer = document.getElementById(piecesId);
    container.innerHTML = '';
    piecesContainer.innerHTML = '';
    document.getElementById(messageId).style.display = 'none';

    const img = new Image();
    img.onload = () => {
        // Use the container's dimensions from CSS instead of the image's natural dimensions
        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;

        const gridSize = taskData.gridSize || 4;
        const pieceWidth = containerWidth / gridSize;
        const pieceHeight = containerHeight / gridSize;
        let pieces = [];

        for (let y = 0; y < gridSize; y++) {
            for (let x = 0; x < gridSize; x++) {
                // Create piece
                const piece = document.createElement('div');
                piece.classList.add('jigsaw-piece');
                piece.style.width = `${pieceWidth - 2}px`; // Subtract border width
                piece.style.height = `${pieceHeight - 2}px`; // Subtract border width
                piece.style.backgroundImage = `url(${img.src})`;
                // Set the background size to the container dimensions for correct positioning
                piece.style.backgroundSize = `${containerWidth}px ${containerHeight}px`;
                piece.style.backgroundPosition = `-${x * pieceWidth}px -${y * pieceHeight}px`;
                piece.dataset.correctX = x;
                piece.dataset.correctY = y;
                piece.draggable = true;
                piece.id = `piece-${taskNum}-${x}-${y}`;
                pieces.push(piece);

                // Create slot
                const slot = document.createElement('div');
                slot.classList.add('jigsaw-slot');
                slot.style.width = `${pieceWidth - 2}px`; // Subtract border width
                slot.style.height = `${pieceHeight - 2}px`; // Subtract border width
                slot.dataset.x = x;
                slot.dataset.y = y;
                container.appendChild(slot);
            }
        }

        // Shuffle and add pieces to the pieces container
        pieces.sort(() => Math.random() - 0.5).forEach(p => piecesContainer.appendChild(p));
    };
    img.onerror = () => {
        container.innerText = "Hiba: A kép nem töltődött be.";
    };
    img.src = taskData.image;

    // --- Drag and Drop listeners ---
    piecesContainer.addEventListener('dragstart', e => e.target.classList.add('dragging'));
    container.addEventListener('dragstart', e => e.target.classList.add('dragging'));

    const dragEnd = e => {
        if (e.target && e.target.classList) e.target.classList.remove('dragging');
        checkJigsaw(taskNum, containerId, messageId);
    };
    piecesContainer.addEventListener('dragend', dragEnd);
    container.addEventListener('dragend', dragEnd);

    const dragOver = e => e.preventDefault();
    const drop = e => {
        e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        const draggedEl = document.getElementById(draggedId);
        if (!draggedEl) return;
        if (e.target.classList.contains('jigsaw-slot') && !e.target.hasChildNodes()) {
            e.target.appendChild(draggedEl);
        } else if (e.target.classList.contains('jigsaw-piece')) {
            const parent = e.target.parentElement;
            const sourceParent = draggedEl.parentElement;
            parent.appendChild(draggedEl);
            sourceParent.appendChild(e.target);
        }
    };

    container.addEventListener('dragover', dragOver);
    container.addEventListener('drop', drop);
    piecesContainer.addEventListener('dragover', dragOver);
    piecesContainer.addEventListener('drop', e => {
         e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        const draggedEl = document.getElementById(draggedId);
        if (!draggedEl) return;
        if (e.target === piecesContainer) {
            piecesContainer.appendChild(draggedEl);
        } else {
            // If dropped on a child element just append to container
            piecesContainer.appendChild(draggedEl);
        }
    });

    document.addEventListener('dragstart', e => {
        if (e.target.classList && e.target.classList.contains('jigsaw-piece')) {
            e.dataTransfer.setData('text/plain', e.target.id);
        }
    });
}

function checkJigsaw(taskNum, containerId, messageId) {
    const container = document.getElementById(containerId);
    const slots = container.querySelectorAll('.jigsaw-slot');
    let allCorrect = true;
    for (const slot of slots) {
        const piece = slot.querySelector('.jigsaw-piece');
        if (!piece || piece.dataset.correctX != slot.dataset.x || piece.dataset.correctY != slot.dataset.y) {
            allCorrect = false;
            break;
        }
    }
    if (allCorrect) {
        document.getElementById(messageId).style.display = 'block';
        const successMsg = gameData[currentTeam].tasks[taskNum].successMessage;
        if(successMsg) document.getElementById(messageId).innerText = successMsg;
    }
}

function setupTask1() { setupJigsaw(1, 'jigsaw-container', 'jigsaw-pieces', 'task-1-message'); }
function setupTask5() { setupJigsaw(5, 'jigsaw-container-2', 'jigsaw-pieces-2', 'task-5-message'); }

// =================================================================================
// TASK 2: SELFIE CHALLENGE LOGIC
// =================================================================================
function setupTask2() {
    const taskData = gameData[currentTeam].tasks[2];
    document.getElementById('task-2-image').src = taskData.image || '';
    document.getElementById('task-2-message').style.display = 'none';
    document.getElementById('task-2-button').style.display = 'inline-block';
}

function showTask2Result() {
    const taskData = gameData[currentTeam].tasks[2];
    const messageEl = document.getElementById('task-2-message');
    messageEl.innerText = taskData.successMessage || '';
    messageEl.style.display = 'block';
    document.getElementById('task-2-button').style.display = 'none';
}

// =================================================================================
// TASK 3: TIMELINE LOGIC
// =================================================================================
let timelineItems = [];
function setupTask3() {
    const taskData = gameData[currentTeam].tasks[3];
    const container = document.getElementById('timeline-container');
    container.innerHTML = '';
    document.getElementById('task-3-message').innerText = '';
    
    timelineItems = [...(taskData.items || [])].sort(() => Math.random() - 0.5);
    timelineItems.forEach(itemText => {
        const li = document.createElement('li');
        li.className = 'timeline-item';
        li.draggable = true;
        li.innerText = itemText;
        container.appendChild(li);
    });

    container.addEventListener('dragstart', e => e.target.classList.add('dragging'));
    container.addEventListener('dragend', e => e.target.classList.remove('dragging'));
    container.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        const dragging = document.querySelector('.dragging');
        if (!dragging) return;
        if (afterElement == null) {
            container.appendChild(dragging);
        } else {
            container.insertBefore(dragging, afterElement);
        }
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.timeline-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function checkTimelineOrder() {
    const taskData = gameData[currentTeam].tasks[3];
    const container = document.getElementById('timeline-container');
    const currentOrder = [...container.querySelectorAll('.timeline-item')].map(li => li.innerText);
    const messageEl = document.getElementById('task-3-message');

    if (JSON.stringify(currentOrder) === JSON.stringify(taskData.correctOrder)) {
        messageEl.innerText = taskData.successMessage;
        messageEl.className = 'message success-message';
    } else {
        messageEl.innerText = gameData.general.task3_incorrect_order;
        messageEl.className = 'message';
    }
}

// =================================================================================
// TASK 4: MORSE CODE LOGIC
// =================================================================================
const morseAlphabet = {
    'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....',
    'I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.',
    'Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-',
    'Y':'-.--','Z':'--..',
    '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....',
    '7':'--...','8':'---..','9':'----.'
};

function setupTask4() {
    const taskData = gameData[currentTeam].tasks[4];
    document.getElementById('morse-abc').innerHTML = Object.entries(morseAlphabet).map(([key, value]) => `${key}: ${value}`).join('<br>');
    document.getElementById('morse-secret-text').innerText = taskData.secretMorse || '';
    document.getElementById('morse-input').value = '';
    document.getElementById('morse-input').placeholder = gameData.general.task4_placeholder;
    document.getElementById('task-4-message').innerText = '';
}

function checkMorseCode() {
    const taskData = gameData[currentTeam].tasks[4];
    const userAnswer = document.getElementById('morse-input').value.trim().toUpperCase();
    const messageEl = document.getElementById('task-4-message');

    if (taskData.correctAnswer && userAnswer === taskData.correctAnswer.toUpperCase()) {
        messageEl.innerText = taskData.successMessage || '';
        messageEl.className = 'message success-message';
    } else {
        messageEl.innerText = gameData.general.task4_incorrect_answer;
        messageEl.className = 'message';
    }
}

// =================================================================================
// TASK 6: LIGHTNING QUIZ LOGIC
// =================================================================================
let quizTimer;
let currentQuestionIndex;
let userAnswers;

function setupTask6() {
    document.getElementById('quiz-intro').style.display = 'block';
    document.getElementById('quiz-area').style.display = 'none';
    document.getElementById('quiz-result').style.display = 'none';
}

function startQuiz() {
    currentQuestionIndex = 0;
    userAnswers = [];
    document.getElementById('quiz-intro').style.display = 'none';
    document.getElementById('quiz-result').style.display = 'none';
    document.getElementById('quiz-area').style.display = 'block';
    loadQuizQuestion();
}

function restartQuiz() {
    startQuiz();
}

function loadQuizQuestion() {
    const questions = (gameData[currentTeam].tasks[6] && gameData[currentTeam].tasks[6].questions) || [];
    if (currentQuestionIndex >= questions.length) {
        showQuizResult();
        return;
    }

    const questionData = questions[currentQuestionIndex];
    document.getElementById('quiz-question').innerText = questionData.q;
    const optionsContainer = document.getElementById('quiz-options');
    optionsContainer.innerHTML = '';
    // Shuffle options
    questionData.o.slice().sort(() => Math.random() - 0.5).forEach(option => {
        const button = document.createElement('button');
        button.className = 'quiz-option';
        button.innerText = option;
        button.onclick = () => selectQuizAnswer(option);
        optionsContainer.appendChild(button);
    });

    startQuizTimer();
}

function selectQuizAnswer(answer) {
    clearTimeout(quizTimer);
    userAnswers[currentQuestionIndex] = answer;
    currentQuestionIndex++;
    loadQuizQuestion();
}

function startQuizTimer() {
    clearTimeout(quizTimer);
    const timerBar = document.getElementById('quiz-timer-bar');
    timerBar.style.transition = 'none';
    timerBar.style.width = '100%';
    
    // Force reflow
    void timerBar.offsetWidth;

    timerBar.style.transition = 'width 5s linear';
    timerBar.style.width = '0%';

    quizTimer = setTimeout(() => {
        userAnswers[currentQuestionIndex] = null; // Timed out
        currentQuestionIndex++;
        loadQuizQuestion();
    }, 5000);
}

function showQuizResult() {
    clearTimeout(quizTimer);
    const taskData = gameData[currentTeam].tasks[6] || { questions: [] };
    let allCorrect = true;
    for (let i = 0; i < taskData.questions.length; i++) {
        if (userAnswers[i] !== taskData.questions[i].a) {
            allCorrect = false;
            break;
        }
    }

    const resultMsgEl = document.getElementById('quiz-result-message');
    const restartBtn = document.getElementById('quiz-restart-button');
    if (allCorrect) {
        resultMsgEl.innerText = taskData.successMessage || '';
        restartBtn.style.display = 'none';
    } else {
        resultMsgEl.innerText = gameData.general.task6_fail_message;
        restartBtn.style.display = 'inline-block';
    }

    document.getElementById('quiz-area').style.display = 'none';
    document.getElementById('quiz-result').style.display = 'block';
}

// =================================================================================
// TASK 7: SPOT THE DIFFERENCE LOGIC
// =================================================================================
let foundDifferences = [];

function setupTask7() {
    const taskData = gameData[currentTeam].tasks[7];
    document.getElementById('spot-image-1').src = taskData.image1 || '';
    document.getElementById('spot-image-2').src = taskData.image2 || '';
    document.getElementById('task-7-message').style.display = 'none';
    
    const wrapper = document.getElementById('spot-image-wrapper-2');
    // Clear previous circles
    wrapper.querySelectorAll('.difference-circle').forEach(c => c.remove());
    foundDifferences = [];
    updateFoundCount();

    // Update total count element in case number of differences differs (keeps UI accurate)
    document.getElementById('differences-total').innerText = (taskData.differences || []).length;

    // Listen to clicks on the image (use the image element for precise coords)
    const img = document.getElementById('spot-image-2');
    // Remove any previous handler to avoid duplicate listeners
    img.onclick = null;

    img.onclick = (event) => {
        const rect = img.getBoundingClientRect();
        // Use rect.width/height (actual rendered size) not img.width which can be natural size
        const width = rect.width;
        const height = rect.height;
        if (width === 0 || height === 0) return;

        // Convert click position to percentages relative to the displayed image
        const x = ((event.clientX - rect.left) / width) * 100;
        const y = ((event.clientY - rect.top) / height) * 100;

        (taskData.differences || []).forEach((diff, index) => {
            if (foundDifferences.includes(index)) return;

            const distance = Math.sqrt(Math.pow(x - diff.x, 2) + Math.pow(y - diff.y, 2));
            if (distance < diff.r) {
                foundDifferences.push(index);
                drawCircle(diff);
                updateFoundCount();
                checkAllDifferencesFound();
            }
        });
    };
}

function drawCircle(diff) {
    const wrapper = document.getElementById('spot-image-wrapper-2');
    const circle = document.createElement('div');
    circle.className = 'difference-circle';
    // diameter in percent (relative to image)
    const diameter = diff.r * 2;
    circle.style.width = `${diameter}%`;
    circle.style.height = `${diameter}%`;
    circle.style.left = `${diff.x - diff.r}%`;
    circle.style.top = `${diff.y - diff.r}%`;
    wrapper.appendChild(circle);
}

function updateFoundCount() {
    const total = (gameData[currentTeam] && gameData[currentTeam].tasks[7] && gameData[currentTeam].tasks[7].differences) ? gameData[currentTeam].tasks[7].differences.length : 0;
    document.getElementById('differences-found').innerText = foundDifferences.length;
    // ensure total displayed is up-to-date
    document.getElementById('differences-total').innerText = total;
}

function checkAllDifferencesFound() {
    const taskData = gameData[currentTeam].tasks[7];
    if (foundDifferences.length === (taskData.differences || []).length) {
        const messageEl = document.getElementById('task-7-message');
        messageEl.innerText = taskData.successMessage || 'Gratulálok!';
        messageEl.style.display = 'block';
    }
}

// Apply initial text content on page load for the start screen
applyTextContent();

</script>

</body>
</html>
