<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Történelmi Kalandjáték</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        h1, h2 {
            color: #5a4a42;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .task {
            display: none; /* Hide all tasks by default */
            margin-top: 20px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        input, select {
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 200px;
        }

        .message {
            margin-top: 15px;
            font-weight: bold;
            color: #d9534f;
        }

        .success-message {
            color: #5cb85c;
        }

        /* Task 1 & 5: Jigsaw Puzzle */
        #jigsaw-container, #jigsaw-container-2 {
            position: relative;
            border: 2px solid #ccc;
            margin: 20px auto;
            width: 400px; /* Fixed width */
            height: 300px; /* Fixed height */
            background-color: #eee;
            /* Added for grid layout */
            display: flex;
            flex-wrap: wrap;
            padding: 0;
        }
        #jigsaw-pieces, #jigsaw-pieces-2 {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
            border: 2px dashed #ccc;
            padding: 10px;
        }
        .jigsaw-piece {
            background-size: cover;
            cursor: grab;
            border: 1px solid #fff;
        }
        .jigsaw-slot {
            border: 1px dashed #aaa;
            background-color: #f9f9f9;
        }

        /* Task 3: Timeline */
        #timeline-container {
            list-style-type: none;
            padding: 0;
            width: 300px;
            margin: 20px auto;
        }
        .timeline-item {
            background-color: #e7e7e7;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 5px;
            cursor: move;
            user-select: none;
        }
        .timeline-item.dragging {
            opacity: 0.5;
        }

        /* Task 4: Morse Code */
        #morse-abc {
            font-family: 'Courier New', Courier, monospace;
            text-align: left;
            max-width: 300px;
            margin: 20px auto;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }

        /* Task 6: Lightning Quiz */
        #quiz-timer-bar-container {
            width: 100%;
            background-color: #ddd;
            height: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        #quiz-timer-bar {
            width: 100%;
            height: 100%;
            background-color: #4CAF50;
            border-radius: 10px;
            transition: width 0.1s linear;
        }
        .quiz-option {
            display: block;
            width: 80%;
            margin: 5px auto;
        }

        /* Task 7: Spot the Difference */
        #spot-the-difference-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .spot-image-wrapper {
            position: relative;
        }
        .spot-image-wrapper img {
            display: block;
            max-width: 400px;
            height: auto;
        }
        .difference-circle {
            position: absolute;
            border: 3px solid red;
            border-radius: 50%;
            pointer-events: none; /* So it doesn't interfere with clicks */
            box-sizing: border-box;
        }

    </style>
</head>
<body>

<div class="container">
    <!-- ================================================== -->
    <!-- START SCREEN -->
    <!-- ================================================== -->
    <div id="start-screen">
        <h1 data-text="start_title">Történelmi Kalandjáték</h1>
        <p data-text="start_intro">Válasszátok ki a csapatotok színét és a feladat sorszámát a kezdéshez!</p>
        <div>
            <label for="team-color" data-text="start_team_label">Csapat színe:</label>
            <select id="team-color">
                <option value="yellow">Sárga</option>
                <option value="green">Zöld</option>
                <option value="red">Piros</option>
                <option value="blue">Kék</option>
            </select>
        </div>
        <div>
            <label for="task-number" data-text="start_task_label">Feladat sorszáma:</label>
            <input type="number" id="task-number" min="1" max="7" value="1">
        </div>
        <button onclick="startGame()" data-text="start_button">Kezdés!</button>
    </div>

    <!-- ================================================== -->
    <!-- TASK 1: JIGSAW PUZZLE -->
    <!-- ================================================== -->
    <div id="task-1" class="task">
        <h2 data-text="task1_title">1. Feladat: Képkirakó</h2>
        <p data-text="task1_instruction">Rakjátok össze a darabokból a képet!</p>
        <div id="jigsaw-container"></div>
        <div id="jigsaw-pieces"></div>
        <div id="task-1-message" class="message success-message" style="display:none;">
            <!-- Success message is set from JS -->
        </div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 2: SELFIE CHALLENGE -->
    <!-- ================================================== -->
    <div id="task-2" class="task">
        <h2 data-text="task2_title">2. Feladat: Alkosd újra!</h2>
        <p id="task-2-instruction" data-text="task2_instruction">Képzeljétek el, hogy most itt vagytok, alkossátok meg a képet és készítsetek egy szelfit.</p>
        <img id="task-2-image" src="" alt="Alkossátok újra" style="max-width: 400px; margin: 10px auto; display: block;">
        <button id="task-2-button" onclick="showTask2Result()" data-text="task2_button">Nyomd meg, ha kész vagy</button>
        <div id="task-2-message" class="message success-message" style="display:none;"></div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 3: TIMELINE SORT -->
    <!-- ================================================== -->
    <div id="task-3" class="task">
        <h2 data-text="task3_title">3. Feladat: Idővonal</h2>
        <p data-text="task3_instruction">Húzzátok a neveket a helyes időrendi sorrendbe!</p>
        <ul id="timeline-container"></ul>
        <button onclick="checkTimelineOrder()" data-text="task3_button">Sorrend ellenőrzése</button>
        <div id="task-3-message" class="message"></div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 4: MORSE CODE -->
    <!-- ================================================== -->
    <div id="task-4" class="task">
        <h2 data-text="task4_title">4. Feladat: Morse-kód</h2>
        <p data-text="task4_instruction">Fejtsétek meg a titkos üzenetet a morzeábécé segítségével!</p>
        <div id="morse-abc"></div>
        <p><strong data-text="task4_secret_label">Titkos üzenet:</strong></p>
        <p id="morse-secret-text" style="font-family: 'Courier New', Courier, monospace; font-size: 1.2em;"></p>
        <input type="text" id="morse-input" placeholder="Írjátok ide a megfejtést">
        <button onclick="checkMorseCode()" data-text="task4_button">Megfejtés ellenőrzése</button>
        <div id="task-4-message" class="message"></div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 5: JIGSAW PUZZLE 2 -->
    <!-- ================================================== -->
    <div id="task-5" class="task">
        <h2 data-text="task5_title">5. Feladat: Képkirakó 2</h2>
        <p data-text="task5_instruction">Rakjátok össze a darabokból a képet!</p>
        <div id="jigsaw-container-2"></div>
        <div id="jigsaw-pieces-2"></div>
        <div id="task-5-message" class="message success-message" style="display:none;">
            <!-- Add success message here -->
        </div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 6: LIGHTNING QUIZ -->
    <!-- ================================================== -->
    <div id="task-6" class="task">
        <h2 data-text="task6_title">6. Feladat: Villámkvíz</h2>
        <div id="quiz-intro">
            <p data-text="task6_instruction">Válaszoljatok helyesen mind az 5 kérdésre. Minden kérdésre 5 másodpercetek van!</p>
            <button onclick="startQuiz()" data-text="task6_start_button">Kvíz indítása</button>
        </div>
        <div id="quiz-area" style="display:none;">
            <div id="quiz-timer-bar-container">
                <div id="quiz-timer-bar"></div>
            </div>
            <h3 id="quiz-question"></h3>
            <div id="quiz-options"></div>
        </div>
        <div id="quiz-result" style="display:none;">
            <p id="quiz-result-message"></p>
            <button id="quiz-restart-button" style="display:none;" onclick="restartQuiz()" data-text="task6_retry_button">Újrapróbálkozás</button>
        </div>
    </div>

    <!-- ================================================== -->
    <!-- TASK 7: SPOT THE DIFFERENCE -->
    <!-- ================================================== -->
    <div id="task-7" class="task">
        <h2 data-text="task7_title">7. Feladat: Különbségkereső</h2>
        <p data-text="task7_instruction">Ezt nem tudtam mukodesre birni ugyhogy keressetek meg.</p>
        <p><span data-text="task7_found_label">Megtalált különbségek:</span> <span id="differences-found">0</span> / <span id="differences-total">5</span></p>
        <div id="spot-the-difference-container">
            <div class="spot-image-wrapper">
                <img id="spot-image-1" src="" alt="Eredeti kép">
            </div>
            <div class="spot-image-wrapper" id="spot-image-wrapper-2">
                <img id="spot-image-2" src="" alt="Módosított kép">
            </div>
        </div>
        <div id="task-7-message" class="message success-message" style="display:none;">
            <!-- Final success message -->
        </div>
    </div>

</div>

<script>

// =================================================================================
// GAME DATA - EDIT THIS SECTION FOR EACH TEAM
// =================================================================================
const gameData = {
    // General text used across the game, not specific to a task
    general: {
        start_title: "Történelmi Kalandjáték",
        start_intro: "Válasszátok ki a csapatotok színét és a feladat sorszámát a kezdéshez!",
        start_team_label: "Csapat színe:",
        start_task_label: "Feladat sorszáma:",
        start_button: "Kezdés!",
        task1_title: "1. Feladat: Képkirakó",
        task1_instruction: "Rakjátok össze a darabokból a képet!",
        task2_title: "2. Feladat: Alkosd újra!",
        task2_instruction: "Képzeljétek el, hogy most itt vagytok, alkossátok meg a képet és készítsetek egy szelfit.",
        task2_button: "Nyomd meg, ha kész vagy",
        task3_title: "3. Feladat: Idővonal",
        task3_instruction: "Húzzátok a neveket a helyes időrendi sorrendbe!",
        task3_button: "Sorrend ellenőrzése",
        task3_incorrect_order: "Nem jó a sorrend, próbáljátok újra!",
        task4_title: "4. Feladat: Morse-kód",
        task4_instruction: "Fejtsétek meg a titkos üzenetet a morzeábécé segítségével!",
        task4_secret_label: "Titkos üzenet:",
        task4_placeholder: "Írjátok ide a megfejtést",
        task4_button: "Megfejtés ellenőrzése",
        task4_incorrect_answer: "Helytelen megfejtés, próbáljátok újra!",
        task5_title: "5. Feladat: Képkirakó 2",
        task5_instruction: "Rakjátok össze a darabokból a képet!",
        task6_title: "6. Feladat: Villámkvíz",
        task6_instruction: "Válaszoljatok helyesen mind az 5 kérdésre. Minden kérdésre 5 másodpercetek van!",
        task6_start_button: "Kvíz indítása",
        task6_retry_button: "Újrapróbálkozás",
        task6_fail_message: "Sajnos nem minden válasz volt helyes. Próbáljátok újra!",
        task7_title: "7. Feladat: Különbségkereső",
        task7_instruction: "Ezt nem tudtam mukodesre birni ugyhogy keressetek meg.",
        task7_found_label: "Megtalált különbségek:",
    },
    yellow: {
        tasks: {
            1: { /* Jigsaw 1 */
                image: 'https://via.placeholder.com/400x300/FFEB3B/000000?text=Jigsaw+1',
                gridSize: 4, // 4x4 grid
                successMessage: 'Keresd meg a következő pontot és fejtsd meg, hogy kit ábrázol a kép! Hint: játszótér'
            },
            2: { /* Selfie */
                image: 'https://csodalatosbudapest.hu/wp-content/uploads/2020/10/budapest-parlament-orszaghaz-duna1-csodalatosbudapest.jpg',
                successMessage: 'A képen I. István azaz Szent István volt, Hint: fa.'
            },
            3: { /* Timeline */
                items: ['Árpád fejedelem', 'Géza', 'Szent István', 'I. András', 'I Béla', 'Szent László', 'III István', 'II András', 'IV. Béla', 'Mátyás király'],
                correctOrder: ['Árpád fejedelem', 'Géza', 'Szent István', 'I. András', 'I Béla', 'Szent László', 'III István', 'II András', 'IV. Béla', 'Mátyás király'],
                successMessage: 'Szent István volt a keresztény magyar állam megalapitója. Hint: ajtó'
            },
            4: { /* Morse */
                secretMorse: '... --.. . -. -  .-.. .- ... --.. .-.. ---',
                correctAnswer: 'Szent László',
                successMessage: 'Szent István eredeti neve Vajk volt! A következő pont mosdók'
            },
            5: { /* Jigsaw 2 */
                image: 'https://via.placeholder.com/400x300/FFE0B2/000000?text=Jigsaw+2',
                gridSize: 5, // 5x5 grid
                successMessage: 'Szent István apja Géza fejedelem volt.! A következő feladat itt található: termünk.'
            },
            6: { /* Quiz */
                questions: [
                    { q: '1. Kiről van szó?', o: ['Szent István', 'Géza', 'Szent László'], a: 'Szent István' },
                    { q: '2. István apja', o: ['István', 'Géza', 'Álmos'], a: 'Géza' },
                    { q: 'István eredeti neve', o: ['István', 'Varj', 'Vajk'], a: 'Vajk' },
                    { q: 'Igen?', o: ['Nem', 'Igen', 'Nemtudom'], a: 'Igen' },
                    { q: 'Hányadik István Szent István?', o: ['I.', 'XIX.', 'III'], a: 'I.' },
                ],
                
                successMessage: 'Helyes!Szent István testvére Koppány volt. Hint: autó'
            },
            7: { /* Spot Difference */
                image1: 'https://raw.githubusercontent.com/Eroan21/myrepo/main/szentistvan.jpg',
                image2: 'https://raw.githubusercontent.com/Eroan21/myrepo/main/szentistvan_processed.jpg',
                // Coordinates: {x, y, r} as percentage of image width/height
                differences: [
                    { x: 45, y: 20, r: 10 }, { x: 13, y: 5, r: 8 },
                    { x: 92, y: 33, r: 9 }, { x: 75, y: 85, r: 7 },
                    { x: 22, y: 94, r: 8 }
                ],
                successMessage: 'Gratulálunk, minden különbséget megtaláltatok! A cél...'
            }
        }
    },
    // Simplified other teams to keep file valid
    green: {
        tasks: {
            1: { image: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=Green+Jigsaw', gridSize: 4, successMessage: 'Gratulálok! Kövi: mosdók' },
            2: { image: 'https://m.blog.hu/to/toriora2/image/kozepkori_var.jpg', successMessage: 'Green selfie done' },
            3: { items: ['Árpád fejedelem', 'Géza', 'Szent István'], correctOrder: ['Árpád fejedelem', 'Géza', 'Szent István'], successMessage: 'Ok' },
            4: { secretMorse: '.- .- .-', correctAnswer: 'AAA', successMessage: 'Ok' },
            5: { image: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=Green+Jigsaw+2', gridSize: 5, successMessage: 'Ok' },
            6: { questions: [ { q: 'Q?', o: ['A','B'], a: 'A' } ], successMessage: 'Ok' },
            7: { image1: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=G1', image2: 'https://via.placeholder.com/400x300/C8E6C9/000000?text=G2', differences: [ { x: 20, y: 20, r: 8 } ], successMessage: 'Done' }
        }
    },
    red: {
        tasks: {
            1: { image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/de/Coloman_%28Chronica_Hungarorum%29.jpg/500px-Coloman_%28Chronica_Hungarorum%29.jpg', gridSize: 4, successMessage: 'Szuper!' },
            2: { image: 'data:image/jpeg;base64,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', successMessage: 'Nagyszerű!' },
            3: { items: ['Árpád fejedelem', 'Géza', 'Szent István'], correctOrder: ['Árpád fejedelem', 'Géza', 'Szent István'], successMessage: 'Helyes!' },
            4: { secretMorse: '-- .- --.', correctAnswer: 'MAG', successMessage: 'Megfejtve!' },
            5: { image: 'https://via.placeholder.com/400x300/FFCDD2/000000?text=Red+Jigsaw+2', gridSize: 5, successMessage: 'Szipiszuper!' },
            6: { questions: [ { q: 'Mi?', o: ['A','B'], a: 'A' } ], successMessage: 'Kész!' },
            7: { image1: 'https://raw.githubusercontent.com/Eroan21/myrepo/main/kalman.jpg', image2: 'https://raw.githubusercontent.com/Eroan21/myrepo/main/kalman_processed.jpg',
                 differences: [ { x: 20, y: 10, r: 10 }, { x: 62, y: 30, r: 5 }, { x: 65, y: 10, r: 5 }, { x: 65, y: 55, r: 5 }, { x: 62, y: 42, r: 5 } ],
                 successMessage: 'Piros csapat - Célba értetek!' }
        }
    },
    blue: {
        tasks: {
            1: { image: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=Kék+Csapat+Kép+1', gridSize: 4, successMessage: 'Kék csapat - Szuper!' },
            2: { image: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=Kék+Csapat+Póz', successMessage: 'Kék csapat - Nagyszerű!' },
            3: { items: ['Árpád fejedelem', 'Géza', 'Szent István'], correctOrder: ['Árpád fejedelem', 'Géza', 'Szent István'], successMessage: 'Ok' },
            4: { secretMorse: '-.- . -.-', correctAnswer: 'KEK', successMessage: 'Kék csapat - Megfejtve!' },
            5: { image: 'https://via.placeholder.com/400x300/BBDEFB/000000?text=Blue+Jigsaw+2', gridSize: 5, successMessage: 'Kék csapat - Ügyesek!' },
            6: { questions: [ { q: 'Kék csapat - 1. kérdés?', o: ['Helyes', 'Rossz'], a: 'Helyes' } ], successMessage: 'Kék csapat - Kész!' },
            7: { image1: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=Kék+Kép+A', image2: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=Kék+Kép+B', differences: [ { x: 15, y: 15, r: 7 } ], successMessage: 'Kék csapat - Kész!' }
        }
    }
};

// =================================================================================
// GLOBAL VARIABLES & HELPER FUNCTIONS
// =================================================================================
let currentTeam = 'yellow';
let currentTask = 1;

function applyTextContent() {
    document.querySelectorAll('[data-text]').forEach(el => {
        const key = el.dataset.text;
        if (gameData.general[key]) el.innerText = gameData.general[key];
    });
}

function hideAllTasks() {
    document.querySelectorAll('.task').forEach(task => task.style.display = 'none');
}

function startGame() {
    currentTeam = document.getElementById('team-color').value;
    currentTask = parseInt(document.getElementById('task-number').value);

    if (isNaN(currentTask) || currentTask < 1 || currentTask > 7) {
        alert('Kérlek, adj meg egy érvényes feladat sorszámot (1-7).');
        return;
    }

    applyTextContent();
    document.getElementById('start-screen').style.display = 'none';
    loadTask(currentTask);
}

function loadTask(taskNumber) {
    hideAllTasks();
    const taskElement = document.getElementById(`task-${taskNumber}`);
    if (taskElement) {
        taskElement.style.display = 'block';
        // Call the setup function for the specific task
        const setupFunction = window[`setupTask${taskNumber}`];
        if (typeof setupFunction === 'function') {
            setupFunction();
        }
    } else {
        alert('Nincs ilyen feladat!');
    }
}

// =================================================================================
// TASK 1 & 5: JIGSAW PUZZLE LOGIC
// =================================================================================
function setupJigsaw(taskNum, containerId, piecesId, messageId) {
    const taskData = gameData[currentTeam].tasks[taskNum];
    const container = document.getElementById(containerId);
    const piecesContainer = document.getElementById(piecesId);
    container.innerHTML = '';
    piecesContainer.innerHTML = '';
    document.getElementById(messageId).style.display = 'none';

    const img = new Image();
    img.onload = () => {
        // Use the container's dimensions from CSS instead of the image's natural dimensions
        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;

        const gridSize = taskData.gridSize || 4;
        const pieceWidth = containerWidth / gridSize;
        const pieceHeight = containerHeight / gridSize;
        let pieces = [];

        for (let y = 0; y < gridSize; y++) {
            for (let x = 0; x < gridSize; x++) {
                // Create piece
                const piece = document.createElement('div');
                piece.classList.add('jigsaw-piece');
                piece.style.width = `${pieceWidth - 2}px`; // Subtract border width
                piece.style.height = `${pieceHeight - 2}px`; // Subtract border width
                piece.style.backgroundImage = `url(${img.src})`;
                // Set the background size to the container dimensions for correct positioning
                piece.style.backgroundSize = `${containerWidth}px ${containerHeight}px`;
                piece.style.backgroundPosition = `-${x * pieceWidth}px -${y * pieceHeight}px`;
                piece.dataset.correctX = x;
                piece.dataset.correctY = y;
                piece.draggable = true;
                piece.id = `piece-${taskNum}-${x}-${y}`;
                pieces.push(piece);

                // Create slot
                const slot = document.createElement('div');
                slot.classList.add('jigsaw-slot');
                slot.style.width = `${pieceWidth - 2}px`; // Subtract border width
                slot.style.height = `${pieceHeight - 2}px`; // Subtract border width
                slot.dataset.x = x;
                slot.dataset.y = y;
                container.appendChild(slot);
            }
        }

        // Shuffle and add pieces to the pieces container
        pieces.sort(() => Math.random() - 0.5).forEach(p => piecesContainer.appendChild(p));
    };
    img.onerror = () => {
        container.innerText = "Hiba: A kép nem töltődött be.";
    };
    img.src = taskData.image;

    // --- Drag and Drop listeners ---
    piecesContainer.addEventListener('dragstart', e => e.target.classList.add('dragging'));
    container.addEventListener('dragstart', e => e.target.classList.add('dragging'));

    const dragEnd = e => {
        if (e.target && e.target.classList) e.target.classList.remove('dragging');
        checkJigsaw(taskNum, containerId, messageId);
    };
    piecesContainer.addEventListener('dragend', dragEnd);
    container.addEventListener('dragend', dragEnd);

    const dragOver = e => e.preventDefault();
    const drop = e => {
        e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        const draggedEl = document.getElementById(draggedId);
        if (!draggedEl) return;
        if (e.target.classList.contains('jigsaw-slot') && !e.target.hasChildNodes()) {
            e.target.appendChild(draggedEl);
        } else if (e.target.classList.contains('jigsaw-piece')) {
            const parent = e.target.parentElement;
            const sourceParent = draggedEl.parentElement;
            parent.appendChild(draggedEl);
            sourceParent.appendChild(e.target);
        }
    };

    container.addEventListener('dragover', dragOver);
    container.addEventListener('drop', drop);
    piecesContainer.addEventListener('dragover', dragOver);
    piecesContainer.addEventListener('drop', e => {
         e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        const draggedEl = document.getElementById(draggedId);
        if (!draggedEl) return;
        if (e.target === piecesContainer) {
            piecesContainer.appendChild(draggedEl);
        } else {
            // If dropped on a child element just append to container
            piecesContainer.appendChild(draggedEl);
        }
    });

    document.addEventListener('dragstart', e => {
        if (e.target.classList && e.target.classList.contains('jigsaw-piece')) {
            e.dataTransfer.setData('text/plain', e.target.id);
        }
    });
}

function checkJigsaw(taskNum, containerId, messageId) {
    const container = document.getElementById(containerId);
    const slots = container.querySelectorAll('.jigsaw-slot');
    let allCorrect = true;
    for (const slot of slots) {
        const piece = slot.querySelector('.jigsaw-piece');
        if (!piece || piece.dataset.correctX != slot.dataset.x || piece.dataset.correctY != slot.dataset.y) {
            allCorrect = false;
            break;
        }
    }
    if (allCorrect) {
        document.getElementById(messageId).style.display = 'block';
        const successMsg = gameData[currentTeam].tasks[taskNum].successMessage;
        if(successMsg) document.getElementById(messageId).innerText = successMsg;
    }
}

function setupTask1() { setupJigsaw(1, 'jigsaw-container', 'jigsaw-pieces', 'task-1-message'); }
function setupTask5() { setupJigsaw(5, 'jigsaw-container-2', 'jigsaw-pieces-2', 'task-5-message'); }

// =================================================================================
// TASK 2: SELFIE CHALLENGE LOGIC
// =================================================================================
function setupTask2() {
    const taskData = gameData[currentTeam].tasks[2];
    document.getElementById('task-2-image').src = taskData.image || '';
    document.getElementById('task-2-message').style.display = 'none';
    document.getElementById('task-2-button').style.display = 'inline-block';
}

function showTask2Result() {
    const taskData = gameData[currentTeam].tasks[2];
    const messageEl = document.getElementById('task-2-message');
    messageEl.innerText = taskData.successMessage || '';
    messageEl.style.display = 'block';
    document.getElementById('task-2-button').style.display = 'none';
}

// =================================================================================
// TASK 3: TIMELINE LOGIC
// =================================================================================
let timelineItems = [];
function setupTask3() {
    const taskData = gameData[currentTeam].tasks[3];
    const container = document.getElementById('timeline-container');
    container.innerHTML = '';
    document.getElementById('task-3-message').innerText = '';
    
    timelineItems = [...(taskData.items || [])].sort(() => Math.random() - 0.5);
    timelineItems.forEach(itemText => {
        const li = document.createElement('li');
        li.className = 'timeline-item';
        li.draggable = true;
        li.innerText = itemText;
        container.appendChild(li);
    });

    container.addEventListener('dragstart', e => e.target.classList.add('dragging'));
    container.addEventListener('dragend', e => e.target.classList.remove('dragging'));
    container.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        const dragging = document.querySelector('.dragging');
        if (!dragging) return;
        if (afterElement == null) {
            container.appendChild(dragging);
        } else {
            container.insertBefore(dragging, afterElement);
        }
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.timeline-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function checkTimelineOrder() {
    const taskData = gameData[currentTeam].tasks[3];
    const container = document.getElementById('timeline-container');
    const currentOrder = [...container.querySelectorAll('.timeline-item')].map(li => li.innerText);
    const messageEl = document.getElementById('task-3-message');

    if (JSON.stringify(currentOrder) === JSON.stringify(taskData.correctOrder)) {
        messageEl.innerText = taskData.successMessage;
        messageEl.className = 'message success-message';
    } else {
        messageEl.innerText = gameData.general.task3_incorrect_order;
        messageEl.className = 'message';
    }
}

// =================================================================================
// TASK 4: MORSE CODE LOGIC
// =================================================================================
const morseAlphabet = {
    'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....',
    'I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.',
    'Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-',
    'Y':'-.--','Z':'--..',
    '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....',
    '7':'--...','8':'---..','9':'----.'
};

function setupTask4() {
    const taskData = gameData[currentTeam].tasks[4];
    document.getElementById('morse-abc').innerHTML = Object.entries(morseAlphabet).map(([key, value]) => `${key}: ${value}`).join('<br>');
    document.getElementById('morse-secret-text').innerText = taskData.secretMorse || '';
    document.getElementById('morse-input').value = '';
    document.getElementById('morse-input').placeholder = gameData.general.task4_placeholder;
    document.getElementById('task-4-message').innerText = '';
}

function checkMorseCode() {
    const taskData = gameData[currentTeam].tasks[4];
    const userAnswer = document.getElementById('morse-input').value.trim().toUpperCase();
    const messageEl = document.getElementById('task-4-message');

    if (taskData.correctAnswer && userAnswer === taskData.correctAnswer.toUpperCase()) {
        messageEl.innerText = taskData.successMessage || '';
        messageEl.className = 'message success-message';
    } else {
        messageEl.innerText = gameData.general.task4_incorrect_answer;
        messageEl.className = 'message';
    }
}

// =================================================================================
// TASK 6: LIGHTNING QUIZ LOGIC
// =================================================================================
let quizTimer;
let currentQuestionIndex;
let userAnswers;

function setupTask6() {
    document.getElementById('quiz-intro').style.display = 'block';
    document.getElementById('quiz-area').style.display = 'none';
    document.getElementById('quiz-result').style.display = 'none';
}

function startQuiz() {
    currentQuestionIndex = 0;
    userAnswers = [];
    document.getElementById('quiz-intro').style.display = 'none';
    document.getElementById('quiz-result').style.display = 'none';
    document.getElementById('quiz-area').style.display = 'block';
    loadQuizQuestion();
}

function restartQuiz() {
    startQuiz();
}

function loadQuizQuestion() {
    const questions = (gameData[currentTeam].tasks[6] && gameData[currentTeam].tasks[6].questions) || [];
    if (currentQuestionIndex >= questions.length) {
        showQuizResult();
        return;
    }

    const questionData = questions[currentQuestionIndex];
    document.getElementById('quiz-question').innerText = questionData.q;
    const optionsContainer = document.getElementById('quiz-options');
    optionsContainer.innerHTML = '';
    // Shuffle options
    questionData.o.slice().sort(() => Math.random() - 0.5).forEach(option => {
        const button = document.createElement('button');
        button.className = 'quiz-option';
        button.innerText = option;
        button.onclick = () => selectQuizAnswer(option);
        optionsContainer.appendChild(button);
    });

    startQuizTimer();
}

function selectQuizAnswer(answer) {
    clearTimeout(quizTimer);
    userAnswers[currentQuestionIndex] = answer;
    currentQuestionIndex++;
    loadQuizQuestion();
}

function startQuizTimer() {
    clearTimeout(quizTimer);
    const timerBar = document.getElementById('quiz-timer-bar');
    timerBar.style.transition = 'none';
    timerBar.style.width = '100%';
    
    // Force reflow
    void timerBar.offsetWidth;

    timerBar.style.transition = 'width 5s linear';
    timerBar.style.width = '0%';

    quizTimer = setTimeout(() => {
        userAnswers[currentQuestionIndex] = null; // Timed out
        currentQuestionIndex++;
        loadQuizQuestion();
    }, 5000);
}

function showQuizResult() {
    clearTimeout(quizTimer);
    const taskData = gameData[currentTeam].tasks[6] || { questions: [] };
    let allCorrect = true;
    for (let i = 0; i < taskData.questions.length; i++) {
        if (userAnswers[i] !== taskData.questions[i].a) {
            allCorrect = false;
            break;
        }
    }

    const resultMsgEl = document.getElementById('quiz-result-message');
    const restartBtn = document.getElementById('quiz-restart-button');
    if (allCorrect) {
        resultMsgEl.innerText = taskData.successMessage || '';
        restartBtn.style.display = 'none';
    } else {
        resultMsgEl.innerText = gameData.general.task6_fail_message;
        restartBtn.style.display = 'inline-block';
    }

    document.getElementById('quiz-area').style.display = 'none';
    document.getElementById('quiz-result').style.display = 'block';
}

// =================================================================================
// TASK 7: SPOT THE DIFFERENCE LOGIC
// =================================================================================
let foundDifferences = [];

function setupTask7() {
    const taskData = gameData[currentTeam].tasks[7];
    document.getElementById('spot-image-1').src = taskData.image1 || '';
    document.getElementById('spot-image-2').src = taskData.image2 || '';
    document.getElementById('task-7-message').style.display = 'none';
    
    const wrapper = document.getElementById('spot-image-wrapper-2');
    // Clear previous circles
    wrapper.querySelectorAll('.difference-circle').forEach(c => c.remove());
    foundDifferences = [];
    updateFoundCount();

    // Update total count element in case number of differences differs (keeps UI accurate)
    document.getElementById('differences-total').innerText = (taskData.differences || []).length;

    // Listen to clicks on the image (use the image element for precise coords)
    const img = document.getElementById('spot-image-2');
    // Remove any previous handler to avoid duplicate listeners
    img.onclick = null;

    img.onclick = (event) => {
        const rect = img.getBoundingClientRect();
        // Use rect.width/height (actual rendered size) not img.width which can be natural size
        const width = rect.width;
        const height = rect.height;
        if (width === 0 || height === 0) return;

        // Convert click position to percentages relative to the displayed image
        const x = ((event.clientX - rect.left) / width) * 100;
        const y = ((event.clientY - rect.top) / height) * 100;

        (taskData.differences || []).forEach((diff, index) => {
            if (foundDifferences.includes(index)) return;

            const distance = Math.sqrt(Math.pow(x - diff.x, 2) + Math.pow(y - diff.y, 2));
            if (distance < diff.r) {
                foundDifferences.push(index);
                drawCircle(diff);
                updateFoundCount();
                checkAllDifferencesFound();
            }
        });
    };
}

function drawCircle(diff) {
    const wrapper = document.getElementById('spot-image-wrapper-2');
    const circle = document.createElement('div');
    circle.className = 'difference-circle';
    // diameter in percent (relative to image)
    const diameter = diff.r * 2;
    circle.style.width = `${diameter}%`;
    circle.style.height = `${diameter}%`;
    circle.style.left = `${diff.x - diff.r}%`;
    circle.style.top = `${diff.y - diff.r}%`;
    wrapper.appendChild(circle);
}

function updateFoundCount() {
    const total = (gameData[currentTeam] && gameData[currentTeam].tasks[7] && gameData[currentTeam].tasks[7].differences) ? gameData[currentTeam].tasks[7].differences.length : 0;
    document.getElementById('differences-found').innerText = foundDifferences.length;
    // ensure total displayed is up-to-date
    document.getElementById('differences-total').innerText = total;
}

function checkAllDifferencesFound() {
    const taskData = gameData[currentTeam].tasks[7];
    if (foundDifferences.length === (taskData.differences || []).length) {
        const messageEl = document.getElementById('task-7-message');
        messageEl.innerText = taskData.successMessage || 'Gratulálok!';
        messageEl.style.display = 'block';
    }
}

// Apply initial text content on page load for the start screen
applyTextContent();

</script>

</body>
</html>
